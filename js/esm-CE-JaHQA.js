import { V as Vec2, a as Vec3, Q as Quat, C as Color, S as Script, W as WasmModule, K as KEY_SPACE, M as Mesh, P as PRIMITIVE_TRISTRIP, b as Shader, c as Material, d as CULLFACE_NONE, B as BLEND_NORMAL, e as BoundingBox, f as MeshInstance, g as SEMANTIC_POSITION, h as SEMANTIC_COLOR } from './index.mjs';

function _define_property$g(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Constants{}_define_property$g(Constants,"EPS",1e-5);_define_property$g(Constants,"EPS2",Constants.EPS*Constants.EPS);_define_property$g(Constants,"INF",1e30);_define_property$g(Constants,"Deg2Rad",Math.PI/180);_define_property$g(Constants,"Rad2Deg",57.29578);_define_property$g(Constants,"DEBUG_DRAW_MIN_LENGTH",.1);_define_property$g(Constants,"CURVE_MOVE_DISTANCE",.05);_define_property$g(Constants,"ANIMATION_DEFAULT_TRANSITION",.1);_define_property$g(Constants,"BODY_DEFAULT_FRICTION",.5);_define_property$g(Constants,"CHARACTER_GROUND_DAMPING",5);_define_property$g(Constants,"CHARACTER_MAX_SPEED",20);_define_property$g(Constants,"CHARACTER_MAX_RADIUS",2);_define_property$g(Constants,"TOWER_BUILDING_START_Y",-4.25);_define_property$g(Constants,"TOWER_BUILDING_END_Y",0);

var constants = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Constants: Constants
});

class Utils{static clampMagnitudeVec2(v,maxLength){var len2=v.lengthSq();if(len2>maxLength*maxLength){var ratio=maxLength/Math.sqrt(len2);return new Vec2(v.x*ratio,v.y*ratio)}return v}static clampMagnitudeVec2InPlace(v,x,y,maxLength){var len2=x*x+y*y;if(len2>maxLength*maxLength){var ratio=maxLength/Math.sqrt(len2);v.set(x*ratio,y*ratio);return}v.set(x,y);}static normalizeVec2(v){var len2=v.lengthSq();if(len2<Constants.EPS2){return Vec2.ZERO.clone()}var len=Math.sqrt(len2);return new Vec2(v.x/len,v.y/len)}static normalizeVec2InPlace(v){var len2=v.lengthSq();if(len2<Constants.EPS2){v.set(0,0);return}v.divScalar(Math.sqrt(len2));}static moveTowards(current,target,maxDelta){var delta=target-current;if(Math.abs(delta)<=maxDelta){return target}if(target<current)return current-maxDelta;else return current+maxDelta}static distanceSqrVec2(a,b){const x=a.x-b.x;const y=a.y-b.y;return x*x+y*y}static distanceSqrVec3(a,b){const x=a.x-b.x;const y=a.y-b.y;const z=a.z-b.z;return x*x+y*y+z*z}static clamp(value,min,max){return Math.min(Math.max(value,min),max)}static lerp(start,end,t){return start*(1-t)+end*t}static isZero(v){return Math.abs(v)<Constants.EPS}static isZeroVec2(v){return v.lengthSq()<Constants.EPS2}static isZeroVec3(v){return v.lengthSq()<Constants.EPS2}static isZeroQuat(q){return q.x*q.x+q.y*q.y+q.z*q.z<Constants.EPS2}static equalVec2(a,b){return Utils.distanceSqrVec2(a,b)<Constants.EPS2}static equalVec3(a,b){return Utils.distanceSqrVec3(a,b)<Constants.EPS2}static equal(a,b){return Math.abs(a-b)<Constants.EPS}static notEqual(a,b){return Math.abs(a-b)>Constants.EPS}static less(a,b){return a<b-Constants.EPS}static lessOrEqual(a,b){return a<b+Constants.EPS}static greater(a,b){return a>b+Constants.EPS}static greaterOrEqual(a,b){return a>b-Constants.EPS}static getPosition3D(position,height=0){return new Vec3(position.x,height,position.y)}static getPosition2D(position3D){return new Vec2(position3D.x,position3D.z)}static normalizeOrientation(orientation){orientation%=360;if(orientation<0)orientation+=360;if(Utils.equal(orientation,360))orientation=0;return orientation}static getOrientationFromDirection(direction,defaultOrientation=0){if(Utils.isZeroVec2(direction)){return defaultOrientation}return Math.atan2(direction.y,direction.x)*Constants.Rad2Deg}static getDirectionFromOrientation(orientation){var angle=orientation*Constants.Deg2Rad;return new Vec2(Math.cos(angle),Math.sin(angle))}static getRotationFromOrientation(orientation){return new Quat().setFromAxisAngle(Vec3.UP,90-orientation)}static getRotationFromOrientationOffset(orientation){return new Quat().setFromAxisAngle(Vec3.UP,-orientation)}static getRotationFromOrientationAndPitch(orientation,pitch){return new Quat().setFromAxisAngle(Vec3.UP,90-orientation).mul(new Quat().setFromAxisAngle(Vec3.RIGHT,-pitch))}static getPitchFromDirection(distanceH,distanceV,defaultPitch=0){if(Utils.isZero(distanceV)){if(Utils.isZero(distanceH)){return defaultPitch}return 0}else if(Utils.isZero(distanceH)){return distanceV<0?-90:90}else {return Math.atan2(distanceV,distanceH)*Constants.Rad2Deg}}static angleBetweenVec3(start,end){var length=Math.sqrt(start.lengthSq()*end.lengthSq());if(Utils.lessOrEqual(length,0)){return 0}var cosA=Utils.clamp(start.dot(end)/length,-1,1);return Math.acos(cosA)*Constants.Rad2Deg}static quatToAxisAngle(q,axis){if(Math.abs(q.w)>1){q.normalize();}var angle=2*Math.acos(q.w);var d=Math.sqrt(1-q.w*q.w);if(Utils.greater(d,0)){axis.set(q.x,q.y,q.z);axis.divScalar(d);}else {axis.set(Vec3.UP);}return angle*Constants.Rad2Deg}static decomposeSwingTwist(q,twistAxis,swing,twist){var r=new Vec3(q.x,q.y,q.z);if(Utils.isZeroVec3(r)){var rotatedTwistAxis=q.transformVector(twistAxis);var swingAxis=new Vec3().cross(twistAxis,rotatedTwistAxis);if(Utils.isZeroVec3(swingAxis)){var swingAngle=Utils.angleBetweenVec3(twistAxis,rotatedTwistAxis);swing.setFromAxisAngle(swingAxis,swingAngle);}else {swing.copy(Quat.IDENTITY);}twist=new Quat().setFromAxisAngle(twistAxis,180);return}var p=r.clone().project(twistAxis);twist.set(p.x,p.y,p.z,q.w);twist.normalize();swing.mul2(q,twist.clone().invert());}static guessRotation(q){var axis=new Vec3;var rotation=Utils.quatToAxisAngle(q,axis);if(Utils.isZero(rotation)){return 0}if(axis.y<0){rotation=-rotation;}return rotation}static getFilenameWithoutExtension(x){return x.replace(/\..+$/,"")}}

var utils = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Utils: Utils
});

class EnemyGridItem{updatePosition(){var position=this.enemy.getPosition();var newGridIndex=this.grid.getGridIndex(position);if(this.gridIndex!==newGridIndex){this.grid.removeItem(this);this.gridIndex=newGridIndex;this.grid.addItem(this);}}remove(){this.grid.removeItem(this);}constructor(grid,enemy){this.grid=grid;this.enemy=enemy;this.next=null;this.prev=null;this.gridIndex=-1;}}class EnemyGrid{destroy(){if(this.rootItems){this.rootItems.length=0;this.rootItems=null;}}createItem(enemy){return new EnemyGridItem(this,enemy)}getGridColumn(x){return Math.floor(x/this.cellSize)}getGridColumn_High(x){return Math.ceil(x/this.cellSize)-1}getGridRow(y){return Math.floor(y/this.cellSize)}getGridRow_High(y){return Math.ceil(y/this.cellSize)-1}getGridIndex(position){var col=Utils.clamp(this.getGridColumn(position.x-this.offset.x),0,this.width-1);var row=Utils.clamp(this.getGridRow(position.y-this.offset.y),0,this.height-1);return col+row*this.width}getGridArrayIndex(col,row){return col+row*this.width}removeItem(item){var gridIndex=item.gridIndex;if(gridIndex===-1)return;item.gridIndex=-1;var prevItem=item.prev;var nextItem=item.next;item.prev=null;item.next=null;if(prevItem!==null){prevItem.next=nextItem;}if(nextItem!==null){nextItem.prev=prevItem;}if(this.rootItems[gridIndex]===item){this.rootItems[gridIndex]=nextItem;}}addItem(item){var gridIndex=item.gridIndex;if(gridIndex===-1)return;var rootItem=this.rootItems[gridIndex];item.next=rootItem;if(rootItem!==null){rootItem.prev=item;}this.rootItems[gridIndex]=item;}processEnemyInCircle(position,radius,func){var x=position.x-this.offset.x;var y=position.y-this.offset.y;var x0=x-radius;var x1=x+radius;var col0=this.getGridColumn(x0);var col1=this.getGridColumn_High(x1);if(col0>col1)return;var dx,dy,y0,y1;var radius2=radius*radius;for(var col=col0;col<=col1;++col){x0=col*this.cellSize;x1=(col+1)*this.cellSize;if(x>x1){dx=x-x1;dy=Math.sqrt(radius2-dx*dx);y0=y-dy;y1=y+dy;}else if(x<x0){dx=x0-x;dy=Math.sqrt(radius2-dx*dx);y0=y-dy;y1=y+dy;}else {y0=y-radius;y1=y+radius;}var row0=this.getGridRow(y0);var row1=this.getGridRow_High(y1);if(row0>row1)continue;for(var row=row0;row<=row1;++row){var item=this.rootItems[this.getGridArrayIndex(col,row)];while(item!=null){var enemy=item.enemy;if(enemy.isAlive()){func(enemy);}item=item.next;}}}}constructor(width,height,cellSize,offset){this.width=width;this.height=height;this.cellSize=cellSize;this.offset=offset;this.totalCell=width*height;this.rootItems=new Array(this.totalCell);this.rootItems.fill(null);}}

var enemy_grid = /*#__PURE__*/Object.freeze({
    __proto__: null,
    EnemyGrid: EnemyGrid,
    EnemyGridItem: EnemyGridItem
});

class EnemyAI{startup(enemy){}shutdown(enemy){enemy.setAIData(null);}update(enemy,dt){}}

var enemy_ai = /*#__PURE__*/Object.freeze({
    __proto__: null,
    EnemyAI: EnemyAI
});

class PathProgress{constructor(){this.segmentIndex=0;this.segmentT=0;}}class Path{getPointFromProgress(pathProgress,p){this.getPoint(pathProgress.segmentIndex,pathProgress.segmentT,p);}getPoint(segmentIndex,segmentT,p){}getDerivativeFromProgress(pathProgress,d){this.getDerivative(pathProgress.segmentIndex,pathProgress.segmentT,d);}getDerivative(segmentIndex,segmentT,d){}getDerivative2FromProgress(pathProgress,d2){this.getDerivative2(pathProgress.segmentIndex,pathProgress.segmentT,d2);}getDerivative2(segmentIndex,segmentT,d2){}move(totalLength,pathProgress){return false}draw(game){}}

var path = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Path: Path,
    PathProgress: PathProgress
});

class FollowPathEnemyAIData{isWaiting(){return Utils.less(this.time,this.waitTime)}constructor(){this.pathProgress=new PathProgress;this.time=0;this.waitTime=0;this.offset=new Vec2;}}class FollowPathEnemyAI extends EnemyAI{startup(enemy){var data=new FollowPathEnemyAIData;enemy.setAIData(data);var pathProgress=enemy.aiData.pathProgress;var vec=new Vec2;this.path.getPointFromProgress(pathProgress,vec);vec.add(data.offset);enemy.forcePosition(vec);this.path.getDerivativeFromProgress(pathProgress,vec);enemy.setOrientationFromDirection(vec);}update(enemy,dt){if(!enemy.isAlive()||!enemy.isMoving()){return}var data=enemy.aiData;data.time+=dt;if(data.isWaiting()){return}var pathProgress=enemy.aiData.pathProgress;var moveLength=enemy.speed*dt;var finished=false;if(this.path.move(moveLength,pathProgress)){finished=true;}var nextPosition=new Vec2;this.path.getPointFromProgress(pathProgress,nextPosition);nextPosition.add(data.offset);enemy.forceMoveToPosition(nextPosition);if(finished){enemy.markDestroy();}}constructor(path){super();this.path=path;}}

var follow_path_enemy_ai = /*#__PURE__*/Object.freeze({
    __proto__: null,
    FollowPathEnemyAI: FollowPathEnemyAI
});

class BezierPathPoint{constructor(p,prevTangent,nextTangent){this.p=p;this.prevTangent=prevTangent;this.nextTangent=nextTangent;}}class BezierPathSegment{getPoint(t,p){var u=1-t;var t2=t*t;var u2=u*u;var startVal=u2*u;var endVal=t2*t;var control0Val=3*u2*t;var control1Val=3*u*t2;p.set(startVal*this.start.x+endVal*this.end.x+control0Val*this.control0.x+control1Val*this.control1.x,startVal*this.start.y+endVal*this.end.y+control0Val*this.control0.y+control1Val*this.control1.y);}getDerivative(t,d){var u=1-t;var t2=t*t;var u2=u*u;var ut=u*t;var startVal=-3*u2;var endVal=3*t2;var control0Val=3*u2-6*ut;var control1Val=6*ut-3*t2;d.set(startVal*this.start.x+endVal*this.end.x+control0Val*this.control0.x+control1Val*this.control1.x,startVal*this.start.y+endVal*this.end.y+control0Val*this.control0.y+control1Val*this.control1.y);}getDerivative2(t,d2){var u=1-t;var startVal=6*u;var endVal=6*t;var control0Val=6*t-12*u;var control1Val=6*u-12*t;d2.set(startVal*this.start.x+endVal*this.end.x+control0Val*this.control0.x+control1Val*this.control1.x,startVal*this.start.y+endVal*this.end.y+control0Val*this.control0.y+control1Val*this.control1.y);}draw(game,color){var t=0;var position=new Vec2;this.getPoint(t,position);var nextPosition=new Vec2;var derivativeVec=new Vec2;var ended=false;while(!ended){this.getDerivative(t,derivativeVec);var derivative=derivativeVec.length();var dt=Constants.CURVE_MOVE_DISTANCE/derivative;var nextT=t+dt;if(Utils.greaterOrEqual(nextT,1)){nextT=1;ended=true;}this.getPoint(nextT,nextPosition);game.drawLine(position,nextPosition,color);position.copy(nextPosition);t=nextT;}}constructor(start,end,control0,control1){this.start=start;this.end=end;this.control0=control0;this.control1=control1;this.straightLength=start.distance(end);}}class BezierPath extends Path{setupSegments(){var pointCount=this.points.length;if(pointCount<2)return;var segmentCount=pointCount-1;this.segments=[];for(var i=0;i<segmentCount;++i){var curPoint=this.points[i];var nextPoint=this.points[i+1];var start=curPoint.p.clone();var end=nextPoint.p.clone();var control0=start.clone();control0.add(curPoint.nextTangent);var control1=end.clone();control1.add(nextPoint.prevTangent);var segment=new BezierPathSegment(start,end,control0,control1);this.segments.push(segment);}}getPoint(segmentIndex,segmentT,p){this.segments[segmentIndex].getPoint(segmentT,p);}getDerivative(segmentIndex,segmentT,d){this.segments[segmentIndex].getDerivative(segmentT,d);}getDerivative2(segmentIndex,segmentT,d2){this.segments[segmentIndex].getDerivative2(segmentT,d2);}move(totalLength,pathProgress){return this.moveToPoint(totalLength,pathProgress,this.segments.length-1,1)}moveToPoint(totalLength,pathProgress,targetSegmentIndex,targetSegmentT){var derivativeVec=new Vec2;while(Utils.greater(totalLength,0)){var length=Math.min(totalLength,Constants.CURVE_MOVE_DISTANCE);this.getDerivative(pathProgress.segmentIndex,pathProgress.segmentT,derivativeVec);var derivative=derivativeVec.length();if(Utils.equal(derivative,0)){derivative=this.segments[pathProgress.segmentIndex].straightLength;}var dt=length/derivative;if(Utils.less(pathProgress.segmentT+dt,1)){pathProgress.segmentT+=dt;totalLength-=length;}else {length=(1-pathProgress.segmentT)*derivative;pathProgress.segmentIndex++;pathProgress.segmentT=0;}if(pathProgress.segmentIndex>targetSegmentIndex||pathProgress.segmentIndex==targetSegmentIndex&&Utils.greaterOrEqual(pathProgress.segmentT,targetSegmentT)){pathProgress.segmentIndex=targetSegmentIndex;pathProgress.segmentT=targetSegmentT;return true}totalLength-=length;}return false}draw(game,color){var segmentCount=this.segments.length;if(segmentCount==0)return;for(var i=0;i<segmentCount;++i){this.segments[i].draw(game,color);}}constructor(data){super();this.points=[];var offset=0;var pathCount=data.getUint16(offset,true);offset+=2;for(var i=0;i<pathCount;++i){var x=data.getFloat32(offset,true);offset+=4;var y=data.getFloat32(offset,true);offset+=4;var p=new Vec2(x,y);x=data.getFloat32(offset,true);offset+=4;y=data.getFloat32(offset,true);offset+=4;var prevTangent=new Vec2(x,y);x=data.getFloat32(offset,true);offset+=4;y=data.getFloat32(offset,true);offset+=4;var nextTangent=new Vec2(x,y);var point=new BezierPathPoint(p,prevTangent,nextTangent);this.points.push(point);}this.setupSegments();}}

var bezier_path = /*#__PURE__*/Object.freeze({
    __proto__: null,
    BezierPath: BezierPath
});

class EnemySpawner{loadData(data,offset){this.delayTime=data.getFloat32(offset,true);offset+=4;this.autoTrigger=!!data.getUint8(offset);offset++;return offset}checkTrigger(){if(this.autoTrigger)return true;return false}trigger(){}update(dt){this.time+=dt;}hasEnded(){return this.time>=this.delayTime}constructor(data){this.time=0;this.loadData(data,0);}}

var enemy_spawner = /*#__PURE__*/Object.freeze({
    __proto__: null,
    EnemySpawner: EnemySpawner
});

class EnemyPathSpawner extends EnemySpawner{loadData(data,offset){offset=super.loadData(data,offset);var pathId=data.getUint8(offset);offset++;this.path=Game.instance.getPath(pathId);this.items=[];var pointCount=data.getUint16(offset,true);offset+=2;for(var i=0;i<pointCount;++i){var id=data.getUint8(offset);offset++;var x=data.getFloat32(offset,true);offset+=4;var y=data.getFloat32(offset,true);offset+=4;var item={"id":id,"position":new Vec2(x,y)};this.items.push(item);}return offset}}

var enemy_path_spawner = /*#__PURE__*/Object.freeze({
    __proto__: null,
    EnemyPathSpawner: EnemyPathSpawner
});

class EnemyPointSpawner extends EnemySpawner{loadData(data,offset){offset=super.loadData(data,offset);this.items=[];var pointCount=data.getUint16(offset,true);offset+=2;for(var i=0;i<pointCount;++i){var id=data.getUint8(offset);offset++;var x=data.getFloat32(offset,true);offset+=4;var y=data.getFloat32(offset,true);offset+=4;var rotation=data.getFloat32(offset,true);offset+=4;var item={"id":id,"position":new Vec2(x,y),"rotation":rotation};this.items.push(item);}return offset}}

var enemy_point_spawner = /*#__PURE__*/Object.freeze({
    __proto__: null,
    EnemyPointSpawner: EnemyPointSpawner
});

function _define_property$f(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Transform2D{clone(){var ret=new Transform2D;ret.copy(this);return ret}copy(rhs){this.p=rhs.p;this.q=rhs.q;return this}transformPointVec(p){return this.transformPoint(p.x,p.y)}transformPoint(px,py){var x=this.q.x*px-this.q.y*py+this.p.x;var y=this.q.y*px+this.q.x*py+this.p.y;return new Vec2(x,y)}invTransformPointVec(p){return this.invTransformPoint(p.x,p.y)}invTransformPoint(px,py){var vx=px-this.p.x;var vy=py-this.p.y;var x=this.q.x*vx+this.q.y*vy;var y=-this.q.y*vx+this.q.x*vy;return new Vec2(x,y)}transformDirectionVec(d){return this.transformDirection(d.x,d.y)}transformDirection(dx,dy){var x=this.q.x*dx-this.q.y*dy;var y=this.q.y*dx+this.q.x*dy;return new Vec2(x,y)}invTransformDirectionVec(d){return this.invTransformDirection(d.x,d.y)}invTransformDirection(dx,dy){var x=this.q.x*dx+this.q.y*dy;var y=-this.q.y*dx+this.q.x*dy;return new Vec2(x,y)}constructor(position,rotation=0){this.p=position.clone();var angle=rotation*Constants.Deg2Rad;this.q=new Vec2(Math.cos(angle),Math.sin(angle));}}_define_property$f(Transform2D,"IDENTITY",Object.freeze(new Transform2D(Vec2.ZERO,0)));

var transform2d = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Transform2D: Transform2D
});

class ShapeType{}(()=>{ShapeType.CIRCLE=0;ShapeType.CAPSULE=1;ShapeType.SEGMENT=2;ShapeType.POLYGON=3;})();

var shape_type = /*#__PURE__*/Object.freeze({
    __proto__: null,
    ShapeType: ShapeType
});

function _define_property$e(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Box2DUtils{static setup(){Box2DUtils.b2Vec2_ZERO=new Box2D.b2Vec2(0,0);Box2DUtils.b2Rot_IDENTITY=Box2DUtils.b2Rot_create(1,0);Box2DUtils.b2Transform_IDENTITY=new Box2D.b2Transform(Box2DUtils.b2Vec2_ZERO,Box2DUtils.b2Rot_IDENTITY);}static b2Vec2_toPC(v){return new Vec2(v.get_x(),v.get_y())}static b2Vec2_create(x,y){return new Box2D.b2Vec2(x,y)}static b2Vec2_fromPC(v){return new Box2D.b2Vec2(v.x,v.y)}static b2Rot_create(c,s){var rot=new Box2D.b2Rot;rot.set_c(c);rot.set_s(s);return rot}static b2Rot_fromPC(v){var rot=new Box2D.b2Rot;rot.set_c(v.x);rot.set_s(v.y);return rot}static b2Transform_create(position,rotation){return new Box2D.b2Transform(Box2DUtils.b2Vec2_fromPC(position),new Box2D.b2Rot(rotation))}static b2Transform_fromPC(transform){var ret=new Box2D.b2Transform;ret.set_p(Box2DUtils.b2Vec2_fromPC(transform.p));ret.set_q(Box2DUtils.b2Vec2_fromPC(transform.q));return ret}static b2Color_toPC(color){var col=Box2D.wrapPointer(color,Box2D.b2Color);var r=col.get_r();var g=col.get_g();var b=col.get_b();return new Color(r,g,b)}}_define_property$e(Box2DUtils,"b2DrawFlag_shapeBit",1);_define_property$e(Box2DUtils,"b2DrawFlag_jointBit",2);_define_property$e(Box2DUtils,"b2DrawFlag_aabbBit",4);_define_property$e(Box2DUtils,"b2DrawFlag_pairBit",8);_define_property$e(Box2DUtils,"b2DrawFlag_centerOfMassBit",16);_define_property$e(Box2DUtils,"b2ShapeType_circle",0);_define_property$e(Box2DUtils,"b2ShapeType_edge",1);_define_property$e(Box2DUtils,"b2ShapeType_polygon",2);_define_property$e(Box2DUtils,"b2ShapeType_chain",3);_define_property$e(Box2DUtils,"b2ShapeType_typeCount",4);_define_property$e(Box2DUtils,"b2Vec2_ZERO",undefined);_define_property$e(Box2DUtils,"b2Rot_IDENTITY",undefined);_define_property$e(Box2DUtils,"b2Transform_IDENTITY",undefined);

var box2d_utils = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Box2DUtils: Box2DUtils
});

function _define_property$d(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Game extends Script{initialize(){Game.instance=this;Game.isReady=false;this.objectDestroyed=this.objectDestroyed.bind(this);this.setMoveLeft=this.setMoveLeft.bind(this);this.setMoveRight=this.setMoveRight.bind(this);this.setMoveUp=this.setMoveUp.bind(this);this.setMoveDown=this.setMoveDown.bind(this);this.once("destroy",this.objectDestroyed);this.moveLeft=false;this.moveRight=false;this.moveUp=false;this.moveDown=false;this.app.on("move:left",this.setMoveLeft);this.app.on("move:right",this.setMoveRight);this.app.on("move:up",this.setMoveUp);this.app.on("move:down",this.setMoveDown);this.world=null;this.joystick=this.joystickEntity?this.joystickEntity.script.joystick:null;this.gameCamera=this.gameCameraEntity?this.gameCameraEntity.script.gameCamera:null;this.move=Vec2.ZERO.clone();this.enemyGrid=new EnemyGrid(this.enemyGridWidth,this.enemyGridHeight,this.enemyGridCellSize,this.enemyGridOffset);this.actors=[];this.player=null;this.actorCount=0;this.actorCap=0;this.loadData();this.loadTemplates();this.loadPaths();this.enemyFollowPathAIMap=null;this.loadEnemySpawners();this.onBox2DDrawSegment=this.onBox2DDrawSegment.bind(this);this.onBox2DDrawPolygon=this.onBox2DDrawPolygon.bind(this);this.onBox2DDrawSolidPolygon=this.onBox2DDrawSolidPolygon.bind(this);this.onBox2DDrawCircle=this.onBox2DDrawCircle.bind(this);this.onBox2DDrawSolidCircle=this.onBox2DDrawSolidCircle.bind(this);this.onBox2DDrawTransform=this.onBox2DDrawTransform.bind(this);this.onBox2DLoaded=this.onBox2DLoaded.bind(this);WasmModule.getInstance("Box2D",this.onBox2DLoaded);}destroy(){if(!Game.isReady){return}this.app.off("move:left",this.setMoveLeft);this.app.off("move:right",this.setMoveRight);this.app.off("move:up",this.setMoveUp);this.app.off("move:down",this.setMoveDown);if(this.actors){for(var i=0;i<this.actorCount;++i){var actor=this.actors[i];actor.destroy();}this.actors=null;this.player=null;}this.actorCount=0;this.actorCap=0;if(this.enemyGrid){this.enemyGrid.destroy();this.enemyGrid=null;}if(this.world){Box2D.destroy(this.world);this.world=null;}Game.isReady=false;Game.instance=null;}objectDestroyed(){this.destroy();}setMoveLeft(value){this.moveLeft=value;}setMoveRight(value){this.moveRight=value;}setMoveUp(value){this.moveUp=value;}setMoveDown(value){this.moveDown=value;}static getWorld(){if(!Game.isReady)return null;return Game.instance.world}static getMove(){if(!Game.isReady)return Vec2.ZERO;return Game.instance.move}loadData(){this.dataMap=new Map;if(!this.dataRootEntity)return;var dataEntities=this.dataRootEntity.children;var dataCount=dataEntities.length;for(var i=0;i<dataCount;++i){var dataEntity=dataEntities[i];this.dataMap.set(dataEntity.name,dataEntity.script.scripts[0]);}}getData(name){return this.dataMap.get(name)}loadPaths(){this.pathArray=[];var pathCount=this.pathAssetArray.length;for(var i=0;i<pathCount;++i){var pathAsset=this.pathAssetArray[i];var path=this.loadPath(pathAsset);this.pathArray.push(path);}}loadPath(asset){var data=new DataView(asset.resource);var path=new BezierPath(data);return path}getPath(pathId){if(pathId<0||pathId>=this.pathArray.length)return null;return this.pathArray[pathId]}loadTemplates(){this.templateMap=new Map;var templateCount=this.templateArray.length;for(var i=0;i<templateCount;++i){var template=this.templateArray[i];this.templateMap.set(template.name,template);}}getTemplate(name){return this.templateMap.get(name)}loadEnemyPathSpawner(asset){var data=new DataView(asset.resource);var spawner=new EnemyPathSpawner(data);return spawner}loadEnemyPointSpawner(asset){var data=new DataView(asset.resource);var spawner=new EnemyPointSpawner(data);return spawner}loadEnemySpawners(){this.enemySpawners=[];var spawnerCount=this.enemyPathSpawnerAssetArray.length;for(var i=0;i<spawnerCount;++i){var spawner=this.loadEnemyPathSpawner(this.enemyPathSpawnerAssetArray[i]);this.enemySpawners.push(spawner);}spawnerCount=this.enemyPointSpawnerAssetArray.length;for(var i=0;i<spawnerCount;++i){var spawner=this.loadEnemyPointSpawner(this.enemyPointSpawnerAssetArray[i]);this.enemySpawners.push(spawner);}}getOrCreateFollowPathEnemyAI(pathId){var enemyAI;if(this.enemyFollowPathAIMap===null){this.enemyFollowPathAIMap=new Map;}else {enemyAI=this.enemyFollowPathAIMap.get(pathId);if(enemyAI!==undefined)return enemyAI}var path=this.getPath(pathId);if(path){enemyAI=new FollowPathEnemyAI(path);}else {enemyAI=null;}this.enemyFollowPathAIMap.set(pathId,enemyAI);return enemyAI}addBox2DDebugSegment(p1,p2,color){color=new Color(1,0,0);this.box2DDebugSegments.push({"start":p1,"end":p2,"color":color});}addBox2DDebugCircle(p,r,color){color=new Color(1,0,0);this.box2DDebugCircles.push({"center":p,"radius":r,"color":color});}onBox2DDrawSegment(_p1,_p2,_color){var p1=Box2DUtils.b2Vec2_toPC(Box2D.wrapPointer(_p1,Box2D.b2Vec2));var p2=Box2DUtils.b2Vec2_toPC(Box2D.wrapPointer(_p2,Box2D.b2Vec2));var color=Box2DUtils.b2Color_toPC(_color);this.addBox2DDebugSegment(p1,p2,color);}onBox2DDrawPolygon(_vertices,_vertexCount,_color){if(_vertexCount<2)return;var color=Box2DUtils.b2Color_toPC(_color);var _lastVertex=Box2D.wrapPointer(_vertices,Box2D.b2Vec2);var _startVertex=_lastVertex;var p1,p2;for(var i=1;i<_vertexCount;++i){var _vertex=Box2D.wrapPointer(_vertices+i*8,Box2D.b2Vec2);p1=Box2DUtils.b2Vec2_toPC(_lastVertex);p2=Box2DUtils.b2Vec2_toPC(_vertex);this.addBox2DDebugSegment(p1,p2,color);_lastVertex=_vertex;}p1=Box2DUtils.b2Vec2_toPC(_lastVertex);p2=Box2DUtils.b2Vec2_toPC(_startVertex);this.addBox2DDebugSegment(p1,p2,color);}onBox2DDrawSolidPolygon(_vertices,_vertexCount,_color){this.onBox2DDrawPolygon(_vertices,_vertexCount,_color);}onBox2DDrawCircle(_center,_radius,_color){var center=Box2DUtils.b2Vec2_toPC(Box2D.wrapPointer(_center,Box2D.b2Vec2));var color=Box2DUtils.b2Color_toPC(_color);this.addBox2DDebugCircle(center,_radius,color);}onBox2DDrawSolidCircle(_center,_radius,_axis,_color){this.onBox2DDrawCircle(_center,_radius,_color);}onBox2DDrawTransform(_transform){}onBox2DLoaded(instance){console.log("BOX 2D LOADED!!!");window["Box2D"]=instance;Box2DUtils.setup();this.world=new Box2D.b2World(Box2DUtils.b2Vec2_ZERO);this.box2DDebugSegments=[];this.box2DDebugCircles=[];var debugDraw=new Box2D.JSDraw;debugDraw.DrawSegment=this.onBox2DDrawSegment;debugDraw.DrawPolygon=this.onBox2DDrawPolygon;debugDraw.DrawSolidPolygon=this.onBox2DDrawSolidPolygon;debugDraw.DrawCircle=this.onBox2DDrawCircle;debugDraw.DrawSolidCircle=this.onBox2DDrawSolidCircle;debugDraw.SetFlags(Box2DUtils.b2DrawFlag_shapeBit);this.world.SetDebugDraw(debugDraw);this.loadStaticColliders();}loadStaticColliders(){var data=new DataView(this.colliderAsset.resource);var offset=0;var colliderCount=data.getUint16(offset,true);offset+=2;for(var i=0;i<colliderCount;++i){var x=data.getFloat32(offset,true);offset+=4;var y=data.getFloat32(offset,true);offset+=4;var rotation=data.getFloat32(offset,true);offset+=4;var transform=new Transform2D(new Vec2(x,y),-rotation);data.getUint8(offset);offset++;var shapeType=data.getUint8(offset);offset++;switch(shapeType){case ShapeType.SEGMENT:{var x1=data.getFloat32(offset,true);offset+=4;var y1=data.getFloat32(offset,true);offset+=4;var x2=data.getFloat32(offset,true);offset+=4;var y2=data.getFloat32(offset,true);offset+=4;this.addStaticSegmentCollider(transform,new Vec2(x1,y1),new Vec2(x2,y2));}break;case ShapeType.CIRCLE:{var x=data.getFloat32(offset,true);offset+=4;var y=data.getFloat32(offset,true);offset+=4;var radius=data.getFloat32(offset,true);offset+=4;this.addStaticCircleCollider(transform,new Vec2(x,y),radius);}break;case ShapeType.CAPSULE:{var x1=data.getFloat32(offset,true);offset+=4;var y1=data.getFloat32(offset,true);offset+=4;var x2=data.getFloat32(offset,true);offset+=4;var y2=data.getFloat32(offset,true);offset+=4;var radius=data.getFloat32(offset,true);offset+=4;this.addStaticCapsuleCollider(transform,new Vec2(x1,y1),new Vec2(x2,y2),radius);}break;case ShapeType.POLYGON:{var pointCount=data.getUint8(offset);offset++;var points=[];for(var j=0;j<pointCount;++j){var x=data.getFloat32(offset,true);offset+=4;var y=data.getFloat32(offset,true);offset+=4;points.push(new Vec2(x,y));}var radius=data.getFloat32(offset,true);offset+=4;this.addStaticPolygonCollider(transform,points,radius);}break}}}createStaticBody(){var bodyDef=new Box2D.b2BodyDef;bodyDef.set_type(Box2D.b2_staticBody);return this.world.CreateBody(bodyDef)}createStaticFixture(body,shape){var fixtureDef=new Box2D.b2FixtureDef;fixtureDef.set_shape(shape);fixtureDef.set_friction(Constants.BODY_DEFAULT_FRICTION);return body.CreateFixture(fixtureDef)}addStaticSegmentCollider(transform,point1,point2){var body=this.createStaticBody();point1=transform.transformPoint(point1.x,point1.y);point2=transform.transformPoint(point2.x,point2.y);var length=point1.distance(point2);var segmentShape=new Box2D.b2EdgeShape;var p1=new Box2D.b2Vec2(-length*.5,0);var p2=new Box2D.b2Vec2(length*.5,0);segmentShape.Set(p1,p2);this.createStaticFixture(body,segmentShape);var position=new Vec2((point1.x+point2.x)*.5,(point1.y+point2.y)*.5);var rotation=Math.atan2(point2.y-point1.y,point2.x-point1.x);body.SetTransform(Box2DUtils.b2Vec2_fromPC(position),rotation);return body}addStaticCapsuleCollider(transform,center1,center2,radius){var body=this.createStaticBody();center1=transform.transformPoint(center1.x,center1.y);center2=transform.transformPoint(center2.x,center2.y);var length=center1.distance(center2);var capsuleShape=new Box2D.b2EdgeShape;var p1=new Box2D.b2Vec2(-length*.5,0);var p2=new Box2D.b2Vec2(length*.5,0);capsuleShape.Set(p1,p2);capsuleShape.set_m_radius(radius);this.createStaticFixture(body,capsuleShape);var position=new Vec2((center1.x+center2.x)*.5,(center1.y+center2.y)*.5);var rotation=Math.atan2(center2.y-center1.y,center2.x-center1.x);body.SetTransform(Box2DUtils.b2Vec2_fromPC(position),rotation);return body}addStaticCircleCollider(transform,center,radius){var body=this.createStaticBody();center=transform.transformPoint(center.x,center.y);var circleShape=new Box2D.b2CircleShape;circleShape.set_m_radius(radius);circleShape.set_m_p(Box2DUtils.b2Vec2_fromPC(center));this.createStaticFixture(body,circleShape);return body}addStaticPolygonCollider(transform,vertices,radius=0){var body=this.createStaticBody();var vertexCount=vertices.length;var buffer=Box2D._malloc(vertexCount*8);var offset=0;for(var i=0;i<vertexCount;++i){var p=transform.transformPoint(vertices[i].x,vertices[i].y);Box2D.HEAPF32[buffer+offset>>2]=p.x;Box2D.HEAPF32[buffer+(offset+4)>>2]=p.y;offset+=8;}var polygonShape=new Box2D.b2PolygonShape;var ptr_wrapped=Box2D.wrapPointer(buffer,Box2D.b2Vec2);polygonShape.Set(ptr_wrapped,vertexCount);polygonShape.set_m_radius(radius);this.createStaticFixture(body,polygonShape);return body}addStaticAABBCollider(x0,y0,x1,y1){var body=this.createStaticBody();var hx=Math.abs(x1-x0)*.5;var hy=Math.abs(y1-y0)*.5;var cx=(x0+x1)*.5;var cy=(y0+y1)*.5;var polygonShape=new Box2D.b2PolygonShape;polygonShape.SetAsBox(hx,hy,new Box2D.b2Vec2(cx,cy),0);this.createStaticFixture(body,polygonShape);return body}addStaticOBBCollider(center,width,height,angle=0){var body=this.createStaticBody();var hx=width*.5;var hy=height*.5;var polygonShape=new Box2D.b2PolygonShape;polygonShape.SetAsBox(hx,hy);this.createStaticFixture(body,polygonShape);body.SetTransform(Box2DUtils.b2Vec2_fromPC(center),-angle*Constants.Deg2Rad);return body}update(dt){if(!Game.isReady){if(this.world!=null){Game.isReady=true;for(var i=0;i<100;++i){this.spawnEnemy("EnemySmall");}for(var i=0;i<5;++i){this.spawnEnemy("EnemyBig");}this.initializeActors();}else {return}}this.updateInput(dt);this.updatePhysics(dt);this.updateActors(dt);}findGridEnemyInCircle(position,radius,func){this.enemyGrid.processEnemyInCircle(position,radius+Constants.CHARACTER_MAX_RADIUS,func);}updatePhysics(dt){this.world.Step(1/60,6,2);}updateInput(dt){this.move.set(0,0);if(this.joystick){this.move.add(this.joystick.move);}if(this.moveUp){this.move.add(Vec2.UP);}if(this.moveDown){this.move.add(Vec2.DOWN);}if(this.moveLeft){this.move.add(Vec2.LEFT);}if(this.moveRight){this.move.add(Vec2.RIGHT);}Utils.normalizeVec2InPlace(this.move);}setPlayer(player){this.player=player;this.gameCamera.setFollowActor(player);}registerActor(actor){if(this.actorCount<this.actorCap){this.actors[this.actorCount++]=actor;}else {this.actorCount++;this.actorCap++;this.actors.push(actor);}if(Game.isReady){actor.initializeActor();}}initializeActors(){if(this.actorCount===0)return;for(var i=0;i<this.actorCount;++i){var actor=this.actors[i];actor.initializeActor();}}destroyActor(actor){actor.destroy();}updateActors(dt){if(this.actorCount===0)return;var newActorCount=0;for(var i=0;i<this.actorCount;++i){var actor=this.actors[i];actor.updateActor(dt);if(!actor.isValid){this.destroyActor(actor);continue}this.actors[newActorCount++]=actor;}if(newActorCount<this.actorCount){for(var i=newActorCount;i<this.actorCount;++i){this.actors[i]=null;}this.actorCount=newActorCount;}}spawnEnemy(name){var template=this.getTemplate(name);if(!template)return;var instance=template.resource.instantiate();this.enemyRootEntity.addChild(instance);return instance.script.enemy}spawnProjectile(name,position,height,orientation){var template=this.getTemplate(name);if(!template)return;var instance=template.resource.instantiate();instance.setLocalPosition(Utils.getPosition3D(position,height));instance.setLocalRotation(Utils.getRotationFromOrientation(orientation));this.projectileRootEntity.addChild(instance);return instance.script.projectile}spawnEffect(name,position,height,autoPlay=true){var template=this.getTemplate(name);if(!template)return;var instance=template.resource.instantiate();instance.setLocalPosition(Utils.getPosition3D(position,height));this.effectRootEntity.addChild(instance);var effect=instance.script.effect;if(autoPlay){effect.play();}return effect}drawLine(start,end,color){this.app.drawLine(Utils.getPosition3D(start),Utils.getPosition3D(end),color,false);}drawCircle(center,radius,color){var len=2*Math.PI*radius;var segmentCount=Math.ceil(len/Constants.DEBUG_DRAW_MIN_LENGTH);var angle=0;var lastPoint=new Vec2(Math.cos(angle)*radius+center.x,Math.sin(angle)*radius+center.y);var point=new Vec2;for(var i=1;i<=segmentCount;++i){angle=2*Math.PI*i/segmentCount;point.set(Math.cos(angle)*radius+center.x,Math.sin(angle)*radius+center.y);this.drawLine(lastPoint,point,color);lastPoint.copy(point);}}drawDebugPhysics(){this.world.DrawDebugData();var segmentCount=this.box2DDebugSegments.length;for(var i=0;i<segmentCount;++i){var segment=this.box2DDebugSegments[i];var start=segment.start;var end=segment.end;var color=segment.color;this.drawLine(start,end,color);}var circleCount=this.box2DDebugCircles.length;for(var i=0;i<circleCount;++i){var circle=this.box2DDebugCircles[i];var center=circle.center;var radius=circle.radius;var color=circle.color;this.drawCircle(center,radius,color);}this.box2DDebugSegments.length=0;this.box2DDebugCircles.length=0;}drawDebugPaths(){var color=new Color(1,0,0);var pathCount=this.pathArray.length;for(var i=0;i<pathCount;++i){var path=this.pathArray[i];path.draw(this,color);}}drawDebug(){this.drawDebugPhysics();this.drawDebugPaths();}postUpdate(dt){if(!Game.isReady)return;this.drawDebug();for(var i=0;i<this.actorCount;++i){var actor=this.actors[i];if(!actor.isValid)continue;actor.postUpdateActor(dt);}}constructor(...args){super(...args);_define_property$d(this,"joystickEntity",void 0);_define_property$d(this,"gameCameraEntity",void 0);_define_property$d(this,"enemyGridOffset",void 0);_define_property$d(this,"enemyGridCellSize",2);_define_property$d(this,"enemyGridWidth",10);_define_property$d(this,"enemyGridHeight",10);_define_property$d(this,"colliderAsset",void 0);_define_property$d(this,"dataRootEntity",void 0);_define_property$d(this,"templateArray",void 0);_define_property$d(this,"pathAssetArray",void 0);_define_property$d(this,"enemyPathSpawnerAssetArray",void 0);_define_property$d(this,"enemyPointSpawnerAssetArray",void 0);_define_property$d(this,"enemyRootEntity",void 0);_define_property$d(this,"projectileRootEntity",void 0);_define_property$d(this,"effectRootEntity",void 0);}}_define_property$d(Game,"scriptName","game");_define_property$d(Game,"isReady",false);_define_property$d(Game,"instance",null);

var game = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Game: Game
});

function _define_property$c(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Actor extends Script{initialize(){this.isValid=false;}postInitialize(){Game.instance.registerActor(this);}getLookAtDirection(other){var otherPosition=other.getPosition();var direction=new Vec2(otherPosition.x-this.position.x,otherPosition.y-this.position.y);Utils.normalizeVec2InPlace(direction);return direction}getLookAtOrientation(other){var otherPosition=other.getPosition();var direction=new Vec2(otherPosition.x-this.position.x,otherPosition.y-this.position.y);return Utils.getOrientationFromDirection(direction)}getDistanceToOther(other){return this.position.distance(other.position)}getEdgeDistanceToOther(other){return Math.max(this.getDistanceToOther(other)-other.radius,0)}setEntityPosition(p){return this.entity.setLocalPosition(p)}setEntityRotation(r){return this.entity.setLocalRotation(r)}getEntityPosition(){return this.entity.getLocalPosition()}getOrientation(){return this.orientation}setPosition(p){this.position.copy(p);}getPosition(){return this.position}setOrientation(o){this.orientation=o;}setOrientationFromDirection(direction){this.orientation=Utils.getOrientationFromDirection(direction,this.orientation);}markDestroy(){this.isValid=false;}destroy(){if(this.isDestroyed)return;this.isValid=false;this.isDestroyed=true;this.deinitializeActor();this.entity.destroy();}deinitializeActor(){this.clearData();this.clearPhysics();}clearData(){}clearPhysics(){}initializeActor(){this.isValid=true;this.isDestroyed=false;this.setupData();this.setupPhysics();}setupData(){this.position=Utils.getPosition2D(this.entity.getLocalPosition());this.orientation=90-Utils.guessRotation(this.entity.getLocalRotation());}setupPhysics(){}updateActor(dt){this.updatePhysics(dt);this.updateState(dt);this.updateDisplay(dt);}postUpdateActor(dt){}updatePhysics(dt){}setState(newState,force=false){if(newState===this.state&&!force)return;this.onStateExit(this.state,newState);this.prevState=this.state;this.state=newState;this.onStateEnter(this.state,this.prevState);}onStateEnter(state,prevState){}onStateExit(state,newState){}updateState(dt){}updateDisplay(dt){this.setEntityPosition(Utils.getPosition3D(this.position));this.setEntityRotation(Utils.getRotationFromOrientation(this.orientation));}}_define_property$c(Actor,"scriptName","actor");

var actor = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Actor: Actor
});

function _define_property$b(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Character extends Actor{getCharacterType(){return Character.TYPE_UNKNOWN}initialize(){super.initialize();this.animationLayer=this.entity.anim.baseLayer;this.disablePhysics=false;}postInitialize(){super.postInitialize();}setVelocity(v){this.velocity.copy(v);}setTargetVelocity(v){this.targetVelocity.copy(v);}setTargetVelocityFromDirection(direction){this.targetVelocity.copy(direction);this.targetVelocity.mulScalar(this.speed);}getBodyPosition(){return Box2DUtils.b2Vec2_toPC(this.body.GetPosition())}setBodyPosition(p){this.body.SetTransform(Box2DUtils.b2Vec2_fromPC(p),0);}getBodyVelocity(){return Box2DUtils.b2Vec2_toPC(this.body.GetLinearVelocity())}setBodyVelocity(v){this.body.SetLinearVelocity(Box2DUtils.b2Vec2_fromPC(v));}addBodyVelocity(v){var bodyVelocity=this.getBodyVelocity().add(v);bodyVelocity=Utils.clampMagnitudeVec2(bodyVelocity,Constants.CHARACTER_MAX_SPEED);this.setBodyVelocity(bodyVelocity);}forceVelocity(velocity){this.setVelocity(velocity);this.setBodyVelocity(velocity);}setupPhysics(){super.setupPhysics();if(this.disablePhysics){this.body=null;return}var bodyDef=new Box2D.b2BodyDef;bodyDef.set_type(Box2D.b2_dynamicBody);bodyDef.set_linearDamping(Constants.CHARACTER_GROUND_DAMPING);bodyDef.set_fixedRotation(true);this.body=Game.getWorld().CreateBody(bodyDef);var circleShape=new Box2D.b2CircleShape;circleShape.set_m_radius(this.radius);var fixtureDef=new Box2D.b2FixtureDef;fixtureDef.set_shape(circleShape);fixtureDef.set_friction(Constants.BODY_DEFAULT_FRICTION);this.body.CreateFixture(fixtureDef);var massData=new Box2D.b2MassData;massData.set_mass(this.mass);this.body.SetMassData(massData);this.body.SetTransform(Box2DUtils.b2Vec2_fromPC(this.position),0);this.body.SetLinearVelocity(Box2DUtils.b2Vec2_ZERO);}clearPhysics(){if(this.body){Game.getWorld().DestroyBody(this.body);this.body=null;}super.clearPhysics();}isAlive(){if(!this.isValid)return false;return this.state!=Character.STATE_DIE}setupData(){super.setupData();this.velocity=Vec2.ZERO.clone();this.targetVelocity=Vec2.ZERO.clone();this.state=Character.STATE_MOVE;this.prevState=this.state;this.animation=Character.ANIMATION_IDLE;this.prevAnimation=this.animation;this.animationTransitionData=Game.instance.getData(this.animationTransitionDataName);this.health=this.maxHealth;}updateActor(dt){super.updateActor(dt);}postUpdateActor(dt){super.postUpdateActor(dt);}updatePhysics(dt){if(!this.body){return}var bodyPosition=this.getBodyPosition();this.setPosition(bodyPosition);var bodyVelocity=Utils.clampMagnitudeVec2(this.getBodyVelocity(),Constants.CHARACTER_MAX_SPEED);if(Utils.isZeroVec2(this.targetVelocity)){if(Utils.isZeroVec2(bodyVelocity)){this.forceVelocity(Vec2.ZERO);}else {var bodySpeed=bodyVelocity.length();var bodyDirection=bodyVelocity.clone().divScalar(bodySpeed);bodySpeed=Math.max(bodySpeed-this.acceleration*dt,0);bodyVelocity=bodyDirection*bodySpeed;this.forceVelocity(bodyVelocity);}}else {var targetSpeed=this.targetVelocity.length();var forward=this.targetVelocity.clone().divScalar(targetSpeed);var right=new Vec2(forward.y,-forward.x);var forwardSpeed=bodyVelocity.dot(forward);var rightSpeed=bodyVelocity.dot(right);forwardSpeed=Utils.moveTowards(forwardSpeed,targetSpeed,this.acceleration*dt);forward.mulScalar(forwardSpeed);right.mulScalar(rightSpeed);forward.add(right);bodyVelocity=Utils.clampMagnitudeVec2(forward,Constants.CHARACTER_MAX_SPEED);this.forceVelocity(bodyVelocity);}}updateState(dt){switch(this.state){case Character.STATE_MOVE:this.updateMove(dt);break;case Character.STATE_ATTACK:this.updateAttack(dt);break;case Character.STATE_DIE:this.updateDie(dt);break}}onStateEnter(state,prevState){switch(state){case Character.STATE_MOVE:this.beginMove();break;case Character.STATE_ATTACK:this.beginAttack();break;case Character.STATE_DIE:this.beginDie();break}}onStateExit(state,newState){switch(state){case Character.STATE_MOVE:this.endMove();break;case Character.STATE_ATTACK:this.endAttack();break;case Character.STATE_DIE:this.endDie();break}}isMoving(){return this.state===Character.STATE_MOVE}move(){this.setState(Character.STATE_MOVE);}attack(){this.setState(Character.STATE_ATTACK,true);}die(){this.setState(Character.STATE_DIE);}beginMove(){}endMove(){}updateMove(dt){}beginAttack(){}endAttack(){}updateAttack(dt){}beginDie(){this.clearPhysics();this.playAnimation(Character.ANIMATION_DIE);}endDie(){}updateDie(dt){if(this.isAtEndAnimation()){this.markDestroy();}}forcePosition(newPosition){this.setPosition(newPosition);if(this.body){this.setBodyPosition(newPosition);}}forceMoveToPosition(newPosition){var move=newPosition.clone().sub(this.position);this.forcePosition(newPosition);if(Utils.isZeroVec2(move)){this.playAnimation(Character.ANIMATION_IDLE);}else {this.setOrientationFromDirection(move);this.playAnimation(Character.ANIMATION_RUN);}}getAnimationTransitionDuration(start,end){if(!this.animationTransitionData)return 0;return this.animationTransitionData.getTranstitionDuration(start,end)}playAnimation(newAnimation,force=false){if(newAnimation===this.animation&&!force)return;var duration=this.getAnimationTransitionDuration(this.animation,newAnimation);this.animation=newAnimation;this.animationLayer.transition(Character.ANIMATION_NAMES[this.animation],duration,0);}isAtEndAnimation(){if(this.animationLayer.transitioning)return false;return this.animationLayer.activeStateProgress>=1}updateDisplay(dt){super.updateDisplay(dt);}takeHit(damage,hitOrientation){this.health-=damage;if(Utils.lessOrEqual(this.health,0)){this.health=0;this.die();}}constructor(...args){super(...args);_define_property$b(this,"radius",1);_define_property$b(this,"targetHeight",1);_define_property$b(this,"mass",1);_define_property$b(this,"speed",10);_define_property$b(this,"acceleration",90);_define_property$b(this,"maxHealth",100);_define_property$b(this,"damage",10);_define_property$b(this,"animationTransitionDataName","");}}_define_property$b(Character,"scriptName","character");(()=>{Character.TYPE_UNKNOWN=-1;Character.TYPE_PLAYER=0;Character.TYPE_ENEMY=1;})();(()=>{Character.STATE_MOVE=0;Character.STATE_ATTACK=1;Character.STATE_DIE=2;})();(()=>{Character.ANIMATION_IDLE=0;Character.ANIMATION_RUN=1;Character.ANIMATION_ATTACK=2;Character.ANIMATION_DIE=3;})();_define_property$b(Character,"ANIMATION_NAMES",["Idle","Run","Attack","Die"]);

var character = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Character: Character
});

function _define_property$a(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Player extends Character{getCharacterType(){return Character.TYPE_PLAYER}setupData(){super.setupData();this.attackOrientationOffset=0;this.hasTopAnimation=false;this.nearestTargetDistance=Constants.INF;this.attackTarget=null;}initialize(){super.initialize();this.onAutoAttackCandidateDetected=this.onAutoAttackCandidateDetected.bind(this);this.animationTopLayer=this.entity.anim.findAnimationLayer("Top");this.fireArrow=this.fireArrow.bind(this);this.willFireArrow=false;this.entity.anim.on("fireArrow",this.fireArrow);}postInitialize(){super.postInitialize();Game.instance.setPlayer(this);}beginMove(){this.updateMoveFromInput();}beginAttack(){this.beginTopAnimation();this.playAttackTopAnimation();this.updateMoveFromInput();this.updateAttackOrientationOffset();}endAttack(){this.endTopAnimation();}beginTopAnimation(){this.hasTopAnimation=true;this.animationTopLayer.weight=1;}endTopAnimation(){this.hasTopAnimation=false;this.animationTopLayer.weight=0;}isAtEndTopAnimation(){if(this.animationTopLayer.transitioning)return false;return this.animationTopLayer.activeStateProgress>=1}playAttackTopAnimation(){this.animationTopLayer.play("Attack");}updateAttackOrientationOffset(){if(!this.attackTarget||!this.attackTarget.isAlive())return;var attackOrientation=this.getLookAtOrientation(this.attackTarget);this.attackOrientationOffset=attackOrientation-this.orientation;}postUpdateActor(dt){if(this.hasTopAnimation){this.splineBoneEntity.rotate(0,-this.attackOrientationOffset,0);}if(this.willFireArrow){this.willFireArrow=false;if(this.attackTarget&&this.attackTarget.isAlive()){var attackPosition3D=this.arrowDummyPoint.getPosition();var attackPosition=Utils.getPosition2D(attackPosition3D);var attackHeight=attackPosition3D.y;var attackOrientation=this.getLookAtOrientation(this.attackTarget);var projectile=Game.instance.spawnProjectile(this.projectileTemplateName,attackPosition,attackHeight,attackOrientation);if(projectile){projectile.target=this.attackTarget;projectile.damage=this.damage;}}}}updateMove(dt){this.updateMoveFromInput();this.checkAutoAttackTarget();if(this.attackTarget!==null){this.attack();}}checkAutoAttackTarget(){this.nearestTargetDistance=Constants.INF;this.attackTarget=null;Game.instance.findGridEnemyInCircle(this.position,this.attackRange,this.onAutoAttackCandidateDetected);}onAutoAttackCandidateDetected(enemy){var distance=this.getEdgeDistanceToOther(enemy);if(Utils.greater(distance,this.attackRange))return;if(distance<this.nearestTargetDistance){this.nearestTargetDistance=distance;this.attackTarget=enemy;}}updateMoveFromInput(){var move=Game.getMove();if(Utils.isZeroVec2(move)){this.setTargetVelocity(Vec2.ZERO);this.playAnimation(Character.ANIMATION_IDLE);}else {this.setTargetVelocityFromDirection(move);this.setOrientationFromDirection(move);this.playAnimation(Character.ANIMATION_RUN);}}fireArrow(){this.willFireArrow=true;}setAttackTarget(attackTarget){if(attackTarget&&attackTarget.isAlive()){this.attackTarget=attackTarget;}else {this.attackTarget=null;}}updateAttack(dt){if(this.attackTarget){if(!this.attackTarget.isAlive()){this.attackTarget=null;}}this.updateMoveFromInput();this.updateAttackOrientationOffset();if(this.isAtEndTopAnimation()){this.setAttackTarget(null);this.move();}}constructor(...args){super(...args);_define_property$a(this,"attackRange",5);_define_property$a(this,"splineBoneEntity",void 0);_define_property$a(this,"arrowDummyPoint",void 0);_define_property$a(this,"projectileTemplateName","projectile");}}_define_property$a(Player,"scriptName","player");

var player = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Player: Player
});

function _define_property$9(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Enemy extends Character{getCharacterType(){return Character.TYPE_ENEMY}initialize(){super.initialize();this.ai=null;this.aiData=null;}postInitialize(){this.disablePhysics=true;this.setAI(Game.instance.getOrCreateFollowPathEnemyAI(0));super.postInitialize();}setupData(){super.setupData();this.setupGridItem();if(this.ai){this.ai.startup(this);this.aiData.waitTime=Math.random()*10;this.aiData.offset.set(Math.random()*3-1.5,Math.random()*3-1.5);}}clearData(){if(this.gridItem){this.gridItem.remove();this.gridItem=null;}if(this.ai){this.ai.shutdown(this);this.ai=null;}this.aiData=null;super.clearData();}setupGridItem(){this.gridItem=Game.instance.enemyGrid.createItem(this);this.gridItem.updatePosition();}updateActor(dt){if(this.ai){this.ai.update(this,dt);}super.updateActor(dt);this.gridItem.updatePosition();}setAI(ai){if(this.ai===ai){return}if(this.ai){this.ai.shutdown(this);}this.ai=ai;if(this.ai&&this.isValid){this.ai.startup(this);}}setAIData(aiData){this.aiData=aiData;}beginMove(){}updateMove(dt){}}_define_property$9(Enemy,"scriptName","enemy");

var enemy = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Enemy: Enemy
});

function _define_property$8(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Joystick extends Script{initialize(){this.onTouchStart=this.onTouchStart.bind(this);this.onTouchEnd=this.onTouchEnd.bind(this);this.onTouchMove=this.onTouchMove.bind(this);this.startPosition=Vec2.ZERO.clone();this.direction=Vec2.ZERO.clone();this.move=Vec2.ZERO.clone();this.app.on(this.touchStartEventName,this.onTouchStart);this.app.on(this.touchEndEventName,this.onTouchEnd);this.app.on(this.touchMoveEventName,this.onTouchMove);this.once("destroy",this.onDestroyed);}onDestroyed(){this.app.off(this.touchStartEventName,this.onTouchStart);this.app.off(this.touchEndEventName,this.onTouchEnd);this.app.off(this.touchMoveEventName,this.onTouchMove);}setPosition(x,y){this.entity.setLocalPosition(x,y,0);}setHandleOffset(x,y){this.handle.setLocalPosition(x,y,0);}setVisible(value){this.entity.element.enabled=value;this.handle.element.enabled=value;}onTouchStart(x,y){this.setVisible(true);this.startPosition.set(x,y);this.setPosition(x,y);this.setHandleOffset(0,0);}onTouchEnd(x,y){this.setVisible(false);this.resetMove();}onTouchMove(x,y){var dx=x-this.startPosition.x;var dy=y-this.startPosition.y;this.updateMove(dx,dy);}resetMove(){this.direction.set(0,0);this.move.set(0,0);this.setHandleOffset(0,0);}updateMove(dx,dy){Utils.clampMagnitudeVec2InPlace(this.direction,dx,dy,this.handleMaxDistance);this.setHandleOffset(this.direction.x,this.direction.y);if(!this.snapping){this.move.set(-this.direction.x/this.handleMaxDistance,this.direction.y/this.handleMaxDistance);}else {this.move.set(-this.direction.x,this.direction.y);Utils.normalizeVec2InPlace(this.move);}}constructor(...args){super(...args);_define_property$8(this,"handle",void 0);_define_property$8(this,"handleMaxDistance",256);_define_property$8(this,"touchStartEventName","touchStart");_define_property$8(this,"touchEndEventName","touchEnd");_define_property$8(this,"touchMoveEventName","touchMove");_define_property$8(this,"snapping",false);}}_define_property$8(Joystick,"scriptName","joystick");

var joystick = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Joystick: Joystick
});

function _define_property$7(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class DesktopInput extends Script{initialize(){this.canvas=this.app.graphicsDevice.canvas;this.onKeyDown=this.onKeyDown.bind(this);this.onKeyUp=this.onKeyUp.bind(this);window.addEventListener("keydown",this.onKeyDown);window.addEventListener("keyup",this.onKeyUp);this.once("destroy",this.onDestroyed);}onDestroyed(){window.removeEventListener("keydown",this.onKeyDown);window.removeEventListener("keyup",this.onKeyUp);}handleKey(key,val){switch(key.toLowerCase()){case"w":case"arrowup":this.app.fire("move:up",val);break;case"s":case"arrowdown":this.app.fire("move:down",val);break;case"a":case"arrowleft":this.app.fire("move:right",val);break;case"d":case"arrowright":this.app.fire("move:left",val);break}}onKeyDown(e){if(e.repeat){return}this.handleKey(e.key,true);}onKeyUp(e){if(e.repeat){return}this.handleKey(e.key,false);}}_define_property$7(DesktopInput,"scriptName","desktopInput");

var desktop_input = /*#__PURE__*/Object.freeze({
    __proto__: null,
    DesktopInput: DesktopInput
});

function _define_property$6(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class MobileInput extends Script{initialize(){this.device=this.app.graphicsDevice;this.canvas=this.app.graphicsDevice.canvas;this.screen=this.screenEntity.screen;this.onTouchStart=this.onTouchStart.bind(this);this.onTouchMove=this.onTouchMove.bind(this);this.onTouchEnd=this.onTouchEnd.bind(this);this.isTouching=false;this.touchId=0;this.touchPosition=Vec2.ZERO.clone();this.canvas.addEventListener("touchstart",this.onTouchStart,false);this.canvas.addEventListener("touchmove",this.onTouchMove,false);this.canvas.addEventListener("touchend",this.onTouchEnd,false);this.once("destroy",this.onDestroyed);}onDestroyed(){this.canvas.removeEventListener("touchstart",this.onTouchStart,false);this.canvas.removeEventListener("touchmove",this.onTouchMove,false);this.canvas.removeEventListener("touchend",this.onTouchEnd,false);}updateTouchPosition(canvasX,canvasY){var scale=this.screen.scale;var screenWidth=this.device.width/scale;var screenHeight=this.device.height/scale;this.touchPosition.set(screenWidth*canvasX/this.canvas.clientWidth,screenHeight*(1-canvasY/this.canvas.clientHeight));}onTouchStart(e){if(this.isTouching)return;e.preventDefault();var touches=e.changedTouches;var touchCount=touches.length;if(touchCount==0)return;var touch=touches[0];this.isTouching=true;this.touchId=touch.identifier;this.updateTouchPosition(touch.pageX,touch.pageY);this.app.fire("joystick:start",this.touchPosition.x,this.touchPosition.y);}onTouchEnd(e){if(!this.isTouching)return;e.preventDefault();var touches=e.changedTouches;var touchCount=touches.length;if(touchCount==0)return;for(var i=0;i<touchCount;++i){var touch=touches[i];if(touch.identifier!==this.touchId)continue;this.isTouching=false;this.touchId=0;this.updateTouchPosition(touch.pageX,touch.pageY);this.app.fire("joystick:end",this.touchPosition.x,this.touchPosition.y);break}}onTouchMove(e){if(!this.isTouching)return;e.preventDefault();var touches=e.changedTouches;var touchCount=touches.length;if(touchCount==0)return;for(var i=0;i<touchCount;++i){var touch=touches[i];if(touch.identifier!==this.touchId)continue;this.updateTouchPosition(touch.pageX,touch.pageY);this.app.fire("joystick:move",this.touchPosition.x,this.touchPosition.y);break}}update(dt){}constructor(...args){super(...args);_define_property$6(this,"screenEntity",void 0);}}_define_property$6(MobileInput,"scriptName","mobileInput");

var mobile_input = /*#__PURE__*/Object.freeze({
    __proto__: null,
    MobileInput: MobileInput
});

function _define_property$5(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class GameCamera extends Script{initialize(){this.followActor=null;this.position=this.entity.getLocalPosition();this.positionOffset=Vec3.ZERO.clone();}setFollowActor(actor){this.followActor=actor;this.positionOffset.copy(this.position);this.positionOffset.sub(this.followActor.getEntityPosition());}postUpdate(dt){if(this.followActor===null)return;this.position.copy(this.followActor.getEntityPosition());this.position.add(this.positionOffset);this.entity.setLocalPosition(this.position);}}_define_property$5(GameCamera,"scriptName","gameCamera");

var game_camera = /*#__PURE__*/Object.freeze({
    __proto__: null,
    GameCamera: GameCamera
});

function _define_property$4(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class AnimTransitionData extends Script{getTranstitionDuration(start,end){var itemCount=this.items?this.items.length:0;for(var i=0;i<itemCount;++i){var item=this.items[i];if(item.isValid(start,end)){return item.duration}}return this.defaultDuration}constructor(...args){super(...args);_define_property$4(this,"items",void 0);_define_property$4(this,"defaultDuration",0);}}_define_property$4(AnimTransitionData,"scriptName","animTransitionData");

var anim_transition_data = /*#__PURE__*/Object.freeze({
    __proto__: null,
    AnimTransitionData: AnimTransitionData
});

function _define_property$3(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Tower extends Actor{initialize(){super.initialize();this.animationLayer=this.ballistaEntity.anim.baseLayer;this.onAutoAttackCandidateDetected=this.onAutoAttackCandidateDetected.bind(this);this.fireArrow=this.fireArrow.bind(this);this.ballistaEntity.anim.on("fireArrow",this.fireArrow);}setupData(){super.setupData();this.attackOrientationOffset=0;this.state=Tower.STATE_EMPTY;this.prevState=this.state;this.buildingHeight=0;this.setVisible(false);this.nearestTargetDistance=Constants.INF;this.attackTarget=null;}setVisible(visible){var visibleEntityCount=this.visibleEntities.length;for(var i=0;i<visibleEntityCount;++i){this.visibleEntities[i].enabled=visible;}}updateState(dt){switch(this.state){case Tower.STATE_EMPTY:this.updateEmpty(dt);break;case Tower.STATE_BUILDING:this.updateBuilding(dt);break;case Tower.STATE_IDLE:this.updateIdle(dt);break;case Tower.STATE_ATTACK:this.updateAttack(dt);break}}onStateEnter(state,prevState){switch(state){case Tower.STATE_BUILDING:this.setVisible(true);this.buildingHeight=Constants.TOWER_BUILDING_START_Y;this.updateBuildingPosition();break;case Tower.STATE_ATTACK:this.animationLayer.transition("Attack",Constants.ANIMATION_DEFAULT_TRANSITION,0);this.updateAttackOrientationOffset();break}}onStateExit(state,newState){switch(state){case Tower.STATE_ATTACK:this.animationLayer.transition("Idle",Constants.ANIMATION_DEFAULT_TRANSITION,0);break}}building(){this.setState(Tower.STATE_BUILDING);}attack(){this.setState(Tower.STATE_ATTACK,true);}idle(){this.setState(Tower.STATE_IDLE);}updateEmpty(dt){if(this.app.keyboard.wasPressed(KEY_SPACE)){this.building();}}updateBuilding(dt){this.buildingHeight+=this.buildingVelocityY*dt;var finished=false;if(this.buildingHeight>=Constants.TOWER_BUILDING_END_Y){this.buildingHeight=Constants.TOWER_BUILDING_END_Y;finished=true;}this.updateBuildingPosition();if(finished){this.idle();}}updateIdle(dt){this.checkAutoAttackTarget();if(this.attackTarget!==null){this.attack();}}updateAttack(dt){if(this.attackTarget){if(!this.attackTarget.isAlive()){this.attackTarget=null;}}this.updateAttackOrientationOffset();if(this.isAtEndAnimation()){this.setAttackTarget(null);this.idle();}}updateBuildingPosition(){this.setEntityPosition(Utils.getPosition3D(this.position,this.buildingHeight));}setAttackTarget(attackTarget){if(attackTarget&&attackTarget.isAlive()){this.attackTarget=attackTarget;}else {this.attackTarget=null;}}checkAutoAttackTarget(){this.nearestTargetDistance=Constants.INF;this.attackTarget=null;Game.instance.findGridEnemyInCircle(this.position,this.attackRange,this.onAutoAttackCandidateDetected);}onAutoAttackCandidateDetected(enemy){var distance=this.getEdgeDistanceToOther(enemy);if(Utils.greater(distance,this.attackRange))return;if(distance<this.nearestTargetDistance){this.nearestTargetDistance=distance;this.attackTarget=enemy;}}setBallistaPivotRotation(r){return this.ballistaPivotEntity.setLocalRotation(r)}updateAttackOrientationOffset(){if(!this.attackTarget||!this.attackTarget.isAlive())return;var attackOrientation=this.getLookAtOrientation(this.attackTarget);this.attackOrientationOffset=attackOrientation-this.orientation;}fireArrow(){if(this.attackTarget&&this.attackTarget.isAlive()){var attackPosition3D=this.arrowDummyPoint.getPosition();var attackPosition=Utils.getPosition2D(attackPosition3D);var attackHeight=attackPosition3D.y;var attackOrientation=this.getLookAtOrientation(this.attackTarget);var projectile=Game.instance.spawnProjectile(this.projectileTemplateName,attackPosition,attackHeight,attackOrientation);if(projectile){projectile.target=this.attackTarget;projectile.damage=this.damage;}}}isAtEndAnimation(){if(this.animationLayer.transitioning)return false;return this.animationLayer.activeStateProgress>=1}updateDisplay(dt){this.ballistaPivotEntity.setLocalRotation(Utils.getRotationFromOrientationOffset(this.attackOrientationOffset));}constructor(...args){super(...args);_define_property$3(this,"visibleEntities",void 0);_define_property$3(this,"ballistaEntity",void 0);_define_property$3(this,"ballistaPivotEntity",void 0);_define_property$3(this,"arrowDummyPoint",void 0);_define_property$3(this,"buildingVelocityY",5);_define_property$3(this,"attackRange",5);_define_property$3(this,"damage",10);_define_property$3(this,"projectileTemplateName","projectile");}}_define_property$3(Tower,"scriptName","tower");(()=>{Tower.STATE_EMPTY=0;Tower.STATE_BUILDING=1;Tower.STATE_IDLE=2;Tower.STATE_ATTACK=3;})();(()=>{Tower.ANIMATION_IDLE=0;Tower.ANIMATION_ATTACK=1;})();

var tower = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Tower: Tower
});

function _define_property$2(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Projectile extends Actor{initialize(){super.initialize();this.displayEntities=[];var displayCount=this.displayEntityPaths.length;for(var i=0;i<displayCount;++i){var path=this.displayEntityPaths[i];var displayEntity=this.entity.findByPath(path);this.displayEntities.push(displayEntity);}}setDisplayVisible(value){var displayCount=this.displayEntities.length;for(var i=0;i<displayCount;++i){this.displayEntities[i].enabled=value;}}setupData(){super.setupData();this.height=this.entity.getPosition().y;this.pitch=0;this.time=0;this.target=null;this.hasHit=false;}onHit(){if(this.hasHit)return;this.hasHit=true;if(this.target&&this.target.isAlive()){this.target.takeHit(this.damage,this.orientation);}this.setDisplayVisible(false);Game.instance.spawnEffect(this.hitEffectTemplateName,this.getPosition(),this.height);}updateState(dt){this.time+=dt;if(this.hasHit){if(Utils.greaterOrEqual(this.time,this.endWaitTime)){this.markDestroy();}return}if(this.target===null||!this.target.isAlive()){this.onHit();return}if(Utils.greaterOrEqual(this.lifeTime,0)){if(Utils.greater(this.time,this.lifeTime)){this.onHit();return}}var move=this.speed*dt;var position3D=Utils.getPosition3D(this.position,this.height);var targetPosition3D=Utils.getPosition3D(this.target.getPosition(),this.target.targetHeight??0);var dx=targetPosition3D.x-position3D.x;var dy=targetPosition3D.y-position3D.y;var dz=targetPosition3D.z-position3D.z;var distance=Math.sqrt(dx*dx+dz*dz);var edgeDistanceH=distance-this.target.radius-this.radius;if(Utils.lessOrEqual(edgeDistanceH,0)){dx=0;dz=0;distance=0;}this.setOrientation(Utils.getOrientationFromDirection(new Vec2(dx,dz),this.orientation));this.pitch=Utils.getPitchFromDirection(distance,dy,this.pitch);distance=Math.sqrt(dx*dx+dy*dy+dz*dz);if(Utils.greaterOrEqual(move,distance)){move=distance;this.position.x+=dx;this.position.y+=dz;this.height+=dy;this.onHit();return}var ratio=move/distance;this.position.x+=dx*ratio;this.position.y+=dz*ratio;this.height+=dy*ratio;}updateDisplay(dt){this.setEntityPosition(Utils.getPosition3D(this.position,this.height));this.setEntityRotation(Utils.getRotationFromOrientationAndPitch(this.orientation,this.pitch));}constructor(...args){super(...args);_define_property$2(this,"radius",.5);_define_property$2(this,"speed",10);_define_property$2(this,"damage",10);_define_property$2(this,"lifeTime",-1);_define_property$2(this,"endWaitTime",0);_define_property$2(this,"hitEffectTemplateName","hitEffect");_define_property$2(this,"displayEntityPaths",void 0);}}_define_property$2(Projectile,"scriptName","projectile");

var projectile = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Projectile: Projectile
});

function _define_property$1(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Trail extends Script{initialize(){this.time=0;this.points=[];var vertexCount=this.maxPoints*2;this.vertexPositionArray=new Float32Array(vertexCount*3);this.vertexColorArray=new Float32Array(vertexCount*4);this.vertexIndexArray=[];for(let i=0;i<vertexCount;++i){this.vertexIndexArray.push(i);}var device=this.app.graphicsDevice;this.mesh=new Mesh(device);this.mesh.clear(true,false);this.mesh.setPositions(this.vertexPositionArray,3,vertexCount);this.mesh.setColors(this.vertexColorArray,4,vertexCount);this.mesh.setIndices(this.vertexIndexArray,vertexCount);this.mesh.update(PRIMITIVE_TRISTRIP);const shader=new Shader(device,Trail.shaderDef);this.material=new Material;this.material.setShader(shader);this.material.cull=CULLFACE_NONE;this.material.blendType=BLEND_NORMAL;this.material.depthTest=true;this.material.depthWrite=false;this.boundingBox=new BoundingBox;this.meshInstance=new MeshInstance(this.mesh,this.material);this.meshInstance.aabb=this.boundingBox;this.meshInstance._updateAabb=false;var render=this.entity.addComponent("render",{meshInstances:[this.meshInstance],layers:[this.app.scene.layers.getLayerByName("World").id]});render.castShadows=false;render.castShadowsLightmap=false;render.receiveShadows=false;render.enabled=false;}reset(){this.time=0;this.point=[];}addPoint(){while(this.points.length>=this.maxPoints){this.points.pop();}var center=this.entity.getPosition();var right=this.entity.right;this.points.unshift({"center":center.clone(),"right":right.clone().mulScalar(this.width*.5),"time":this.time});}cleanOldPoints(){for(var i=this.points.length-1;i>=0;--i){var point=this.points[i];if(this.time-point.time>=this.vertexTime){this.points.pop();}else {break}}}prepareVertexData(){var pointCount=this.points.length;var posId=0;var colorId=0;for(let i=0;i<pointCount;++i){var point=this.points[i];var ratio=(this.time-point.time)/this.vertexTime;var widthScale=this.widthScaleCurve.value(ratio);var color=this.colorCurve.value(ratio);var center=point.center;var right=point.right;var dx=right.x*widthScale;var dy=right.y*widthScale;var dz=right.z*widthScale;this.vertexPositionArray[posId++]=center.x-dx;this.vertexPositionArray[posId++]=center.y-dy;this.vertexPositionArray[posId++]=center.z-dz;this.vertexColorArray[colorId++]=color[0];this.vertexColorArray[colorId++]=color[1];this.vertexColorArray[colorId++]=color[2];this.vertexColorArray[colorId++]=color[3];this.vertexPositionArray[posId++]=center.x+dx;this.vertexPositionArray[posId++]=center.y+dy;this.vertexPositionArray[posId++]=center.z+dz;this.vertexColorArray[colorId++]=color[0];this.vertexColorArray[colorId++]=color[1];this.vertexColorArray[colorId++]=color[2];this.vertexColorArray[colorId++]=color[3];}this.boundingBox.compute(this.vertexPositionArray,pointCount*2);}update(dt){this.time+=dt;this.cleanOldPoints();this.addPoint();var vertexCount=this.points.length*2;if(vertexCount>1){this.prepareVertexData();this.mesh.setPositions(this.vertexPositionArray,3,vertexCount);this.mesh.setColors(this.vertexColorArray,4,vertexCount);this.mesh.setIndices(this.vertexIndexArray,vertexCount);this.mesh.update(PRIMITIVE_TRISTRIP);this.entity.render.enabled=true;}else {this.entity.render.enabled=false;}}constructor(...args){super(...args);_define_property$1(this,"maxPoints",100);_define_property$1(this,"vertexTime",.1);_define_property$1(this,"vertexDistance",.1);_define_property$1(this,"width",.5);_define_property$1(this,"colorCurve",void 0);_define_property$1(this,"widthScaleCurve",void 0);}}_define_property$1(Trail,"scriptName","trail");_define_property$1(Trail,"shaderDef",{attributes:{aPosition:SEMANTIC_POSITION,aColor:SEMANTIC_COLOR},vshader:`
            attribute vec3 aPosition;
            attribute vec4 aColor;

            uniform mat4 matrix_viewProjection;

            varying vec4 vColor;

            void main(void) {
                vColor = aColor;
                gl_Position = matrix_viewProjection * vec4(aPosition, 1.0);
            }
        `,fshader:`
            precision mediump float;

            varying vec4 vColor;

            void main(void) {
                gl_FragColor = vColor;
            }
        `});

var trail = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Trail: Trail
});

function _define_property(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Effect extends Script{initialize(){this.time=0;this.hasPlayed=false;this.particleEntities=[];var particleCount=this.particleEntityPaths.length;for(var i=0;i<particleCount;++i){var path=this.particleEntityPaths[i];var particleEntity=this.entity.findByPath(path);this.particleEntities.push(particleEntity);}}postInitialize(){var particleCount=this.particleEntities.length;for(var i=0;i<particleCount;++i){var ps=this.particleEntities[i].particlesystem;ps.emitter.material.depthTest=this.depthTest;}}play(){if(this.hasPlayed)return;this.hasPlayed=true;var particleCount=this.particleEntities.length;for(var i=0;i<particleCount;++i){var ps=this.particleEntities[i].particlesystem;ps.play();}}update(dt){if(!this.hasPlayed)return;this.time+=dt;if(Utils.greaterOrEqual(this.destroyTime,0)){if(Utils.greaterOrEqual(this.time,this.destroyTime)){this.entity.destroy();}}}constructor(...args){super(...args);_define_property(this,"particleEntityPaths",void 0);_define_property(this,"destroyTime",1);_define_property(this,"depthTest",false);}}_define_property(Effect,"scriptName","effect");

var effect = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Effect: Effect
});

export { effect as A, enemy_ai as a, bezier_path as b, constants as c, enemy_spawner as d, enemy_grid as e, follow_path_enemy_ai as f, enemy_path_spawner as g, enemy_point_spawner as h, box2d_utils as i, game as j, actor as k, character as l, player as m, enemy as n, joystick as o, path as p, desktop_input as q, mobile_input as r, shape_type as s, transform2d as t, utils as u, game_camera as v, anim_transition_data as w, tower as x, projectile as y, trail as z };
